
#! /bin/bash

#Update and install required packages 
sudo yum update -y 
sudo yum -y install iscsi-initiator-utils
sudo yum -y install lsscsi
sudo yum -y install device-mapper-multipath
sudo yum -y install sshpass


# mutlipath and iscsi best practices configuration
sudo service iscsid start
sudo sed -i 's/^\(node\.session\.nr_sessions\s*=\s*\).*$/\132/' /etc/iscsi/iscsid.conf


sudo cat << EOF > /etc/udev/rules.d/99-pure-storage.rules 
# Recommended settings for Pure Storage FlashArray.cat 
# Use noop scheduler for high-performance solid-state storage
ACTION=="add|change", KERNEL=="sd*[!0-9]", SUBSYSTEM=="block", ENV{ID_VENDOR}=="PURE", ATTR{queue/scheduler}="noop"
# Reduce CPU overhead due to entropy collection
ACTION=="add|change", KERNEL=="sd*[!0-9]", SUBSYSTEM=="block", ENV{ID_VENDOR}=="PURE", ATTR{queue/add_random}="0"
# Spread CPU load by redirecting completions to originating CPU
ACTION=="add|change", KERNEL=="sd*[!0-9]", SUBSYSTEM=="block", ENV{ID_VENDOR}=="PURE", ATTR{queue/rq_affinity}="2"
# Set the HBA timeout to 60 secondsi
ACTION=="add", SUBSYSTEMS=="scsi", ATTRS{model}=="FlashArray ", RUN+="/bin/sh -c 'echo 60 > /sys/$DEVPATH/device/timeout'"
EOF

sudo mpathconf --enable --with_multipathd y

sudo sed -e 's/^#*/#/g' -i /etc/multipath.conf

sudo cat << EOF >> /etc/multipath.conf
defaults {
       polling_interval 10
       user_friendly_names yes
       find_multipaths yes
}cd ../
devices {
       device {
               vendor                "PURE"
               path_selector         "queue-length 0"
               path_grouping_policy  group_by_prio
               path_checker          tur
               fast_io_fail_tmo      10
               no_path_retry         queue
               hardware_handler      "1 alua"
               prio                  alua
               failback              immediate
       }
}
EOF

sudo service multipathd restart

#Storage Provsioning 
iqn=`awk -F= '{ print $2 }' /etc/iscsi/initiatorname.iscsi`
sudo sshpass -p pureuser ssh  -oStrictHostKeyChecking=no pureuser@172.23.2.180 purehost create dev-ubuntu-01 --iqnlist $iqn
sudo sshpass -p pureuser ssh  -oStrictHostKeyChecking=no pureuser@172.23.2.180 purehost connect --vol <vol-name> dev-ubuntu-01

#iscsi initiator configuration
sudo iscsiadm -m iface -I iscsi0 -o new
sudo iscsiadm -m discovery -t st -p 172.23.2.75:3260
sudo iscsiadm -m node -p 172.23.2.75 --login
sudo iscsiadm -m node -p 172.23.2.127 --login
sudo iscsiadm -m node -L automatic
sudo iscsiadm --mode session
sudo iscsiadm --mode session
sudo lsscsi -d
sudo multipath -ll
mpathconf --enable --with_multipathd y
service multipathd restart

#mount volume
mkdir /mnt/datavol
disk=`multipath -ll|awk '{print $1;exit}'`
mount /dev/mapper/$disk /mnt/datavol
